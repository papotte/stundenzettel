rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Users can only read and write to their own data, stored in a
    // document named after their user ID in the 'users' collection.
    match /users/{userId}/{documents=**} {
      allow read, write: if request.auth.uid == userId;
    }
    
    // User-team mappings - users can only access their own mapping
    match /user-teams/{userId} {
      allow read, write: if request.auth.uid == userId;
    }
    
    // Team rules
    match /teams/{teamId} {
      allow read, write: if request.auth.uid != null && 
        (resource == null || 
         request.auth.uid == resource.data.ownerId ||
         exists(/databases/$(database)/documents/teams/$(teamId)/members/$(request.auth.uid)));
      
      // Allow users to query teams collection to find teams they own
      // This is needed for the getUserTeam function to work efficiently
      allow list: if request.auth.uid != null && 
        request.query.limit <= 10 && // Limit to prevent abuse
        request.query.filters[0].fieldPath == 'ownerId' &&
        request.query.filters[0].op == '==' &&
        request.query.filters[0].value == request.auth.uid;
    }
    
    match /teams/{teamId}/members/{memberId} {
      allow read, write: if request.auth.uid != null && 
        (request.auth.uid == memberId ||
         request.auth.uid == get(/databases/$(database)/documents/teams/$(teamId)).data.ownerId ||
         exists(/databases/$(database)/documents/teams/$(teamId)/members/$(request.auth.uid)));
    }
    
    match /teams/{teamId}/users/{userId} {
      allow read, write: if request.auth.uid != null && 
        (request.auth.uid == userId ||
         request.auth.uid == get(/databases/$(database)/documents/teams/$(teamId)).data.ownerId);
    }
    
    match /teams/{teamId}/subscription/{doc=**} {
      allow read, write: if request.auth.uid != null && 
        (request.auth.uid == get(/databases/$(database)/documents/teams/$(teamId)).data.ownerId ||
         exists(/databases/$(database)/documents/teams/$(teamId)/members/$(request.auth.uid)));
    }
    
    match /teams/{teamId}/payments/{doc=**} {
      allow read, write: if request.auth.uid != null && 
        (request.auth.uid == get(/databases/$(database)/documents/teams/$(teamId)).data.ownerId ||
         exists(/databases/$(database)/documents/teams/$(teamId)/members/$(request.auth.uid)));
    }
    
    // Team invitations - SIMPLIFIED FOR TESTING
    match /team-invitations/{invitationId} {
      allow read, write: if request.auth.uid != null;
      
      // Allow users to query team-invitations
      allow list: if request.auth.uid != null && 
        request.query.limit <= 10;
    }
  }
}
